"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(s,o){try{var i=t[s](o),a=i.value}catch(e){return void n(e)}if(!i.done)return Promise.resolve(a).then(function(e){r("next",e)},function(e){r("throw",e)});e(a)}return r("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_service=require("./../../mixins/service.js"),_service2=_interopRequireDefault(_service),_constant=require("./../../mixins/constant.js"),constant=_interopRequireWildcard(_constant),_index=require("./../../utils/index.js"),Utils=_interopRequireWildcard(_index),_wxex=require("./../../mixins/wxex.js"),_wxex2=_interopRequireDefault(_wxex),_zanToptips=require("./../../components/zan-toptips.js"),_zanToptips2=_interopRequireDefault(_zanToptips),_zanLoadmore=require("./../../components/zan-loadmore.js"),_zanLoadmore2=_interopRequireDefault(_zanLoadmore),WorkTypes=constant.WorkTypes,urls={20:"./instorage/chooseC",21:"./putaway/index",22:"./ex/scanBox",23:"./picking/chooseA",25:"./check/sureNum",26:"./binning/scan"},Index=function(e){function t(){var e,n,r,s,o=this;_classCallCheck(this,t);for(var i=arguments.length,a=Array(i),u=0;u<i;u++)a[u]=arguments[u];return n=r=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),r.config={navigationBarTitleText:"待抢的工作"},r.$repeat={},r.$props={zanLoadmore:{"xmlns:v-bind":"","v-bind:nodata.once":"isEmpty",nodata_str:"天道酬勤，没有多余任务了。"}},r.$events={},r.components={zanToptips:_zanToptips2.default,zanLoadmore:_zanLoadmore2.default},r.mixins=[_wxex2.default],r.data={isEmpty:!0,entrustList:[]},r.methods={back:function(){r.backUrl("index")},refuse:function(e){wx.showModal({title:"确认",content:"你真的要拒绝"+e.client+"的委托吗？",confirmText:"确认",cancelText:"取消",success:function(t){t.confirm&&r.closeEntrust(e.entrustId)}})},robInto:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.acceptEntrust(t.entrustId);case 2:wx.showModal({content:"你已成功接受此项工作！",confirmText:"开始执行",cancelText:"再委托",success:function(e){e.confirm?(console.log("开始执行"),r.gotoWork(t)):r.handleEntrust(t)}});case 3:case"end":return e.stop()}},e,o)}));return e}()},s=n,_possibleConstructorReturn(r,s)}return _inherits(t,e),_createClass(t,[{key:"onShow",value:function(){this.getEntrustList()}},{key:"handleEntrust",value:function(e){var t=this,n=Object.assign({},e);console.log(n.isHavePerm,n.entrustId,n.entrustStatus),2==n.isHavePerm?(console.log("委托当前事务"),n.entrustType=1,this.gotoMate(n)):wx.showModal({content:"您已获得授权，除了委托当前事务，还可以委托更长时间的“"+n.busyTypeText+"”工作至："+(n.expireTime||"forerver"),showCancel:!1,success:function(e){e.confirm&&wx.showActionSheet({itemList:["仅委托当前事务","委托更长时间"],success:function(e){n.entrustType=e.tapIndex+1,t.gotoMate(n)},fail:function(e){console.log(e.errMsg)}})}})}},{key:"gotoMate",value:function(e){console.log(e),this.$preload("entrustInfo",e),this.$navigate("./torobs/card-workmate")}},{key:"closeEntrust",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,s,o,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n={status:3,entrustId:t},e.next=3,_service2.default.Apost("entrust/ReceiveEntrust",n);case 3:r=e.sent,s=r.res,o=r.code,i=r.state,a=r.msg,200==o?(this.showTips("取消成功","success"),this.getEntrustList()):this.showTips(a);case 9:case"end":return e.stop()}},e,this)}));return e}()},{key:"acceptEntrust",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,s,o,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n={status:2,entrustId:t},e.next=3,_service2.default.Apost("entrust/ReceiveEntrust",n);case 3:r=e.sent,s=r.res,o=r.code,i=r.state,a=r.msg,200==o?this.getEntrustList():this.showTips(a);case 9:case"end":return e.stop()}},e,this)}));return e}()},{key:"gotoWork",value:function(e){23==e.busyType?this.checkTask(e):27==e.busyType?this.getUnboxArea(e):26==e.busyType?(this.$preload("work",e),e.workMap.status?this.$navigate("./binning/print"):this.$navigate(urls[e.busyType])):(this.$preload("work",e),this.$navigate(urls[e.busyType]))}},{key:"getEntrustList",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,s,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return wx.showLoading({title:"加载中"}),e.next=3,_service2.default.Aget("entrust/EntrustInfoMe",{status:1});case 3:t=e.sent,n=t.res,r=t.code,s=t.msg,o=t.state,wx.hideLoading(),200==r?(this.entrustList=n,this.entrustList.forEach(function(e){if(e.busyType){var t=WorkTypes.find(function(t){return t.id===e.busyType});e.typeFormat=t?t.title:""}e.beforeTime=Utils.calTime(e.createTime)})):(wx.showToast({title:"暂无数据",icon:"success",duration:1e3,success:function(){}}),this.entrustList=[]),this.$apply();case 11:case"end":return e.stop()}},e,this)}));return e}()},{key:"checkTask",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,s,o,i,a,u,c=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n={pickOrderId:t.busyKey,addressId:t.addressId},r=this,e.next=4,_service2.default.Aget("pick/checkTask",n);case 4:s=e.sent,o=s.res,i=s.msg,a=s.state,u=s.code,2004==u?wx.showModal({content:"您尚有未结束的分拣作业！",confirmText:"结束",cancelText:"继续",success:function(e){e.confirm?c.finishTask(o.taskId):(o.addressId=t.addressId,c.$preload("taskInfo",o),2==o.packageType&&0==o.deviceNum?c.$navigate("./picking/scanBox"):c.$navigate("./picking/sureNum"))}}):200==u?(this.$preload("info",{work:t,areaList:o}),this.$navigate(urls[t.busyType])):this.showTips(i);case 10:case"end":return e.stop()}},e,this)}));return e}()},{key:"getUnboxArea",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,s,o,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n={taskId:t.busyKey,addressId:t.addressId},e.next=3,_service2.default.Aget("unbox/getUnboxArea",n);case 3:r=e.sent,s=r.res,o=r.state,i=r.msg,a=r.code,200==a?(this.$preload("info",{work:t,areaList:s}),this.$navigate("./devanning/scan")):this.showTips(i),this.$apply();case 10:case"end":return e.stop()}},e,this)}));return e}()}]),t}(_wepy2.default.page);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(Index,"pages/workbench/torob"));