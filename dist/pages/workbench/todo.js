"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,s){function a(r,n){try{var o=t[r](n),i=o.value}catch(e){return void s(e)}if(!o.done)return Promise.resolve(i).then(function(e){a("next",e)},function(e){a("throw",e)});e(i)}return a("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var a=t[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,s,a){return s&&e(t.prototype,s),a&&e(t,a),t}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_service=require("./../../mixins/service.js"),_service2=_interopRequireDefault(_service),_constant=require("./../../mixins/constant.js"),constant=_interopRequireWildcard(_constant),_wxex=require("./../../mixins/wxex.js"),_wxex2=_interopRequireDefault(_wxex),_zanTab=require("./../../components/zan-tab.js"),_zanTab2=_interopRequireDefault(_zanTab),_zanToptips=require("./../../components/zan-toptips.js"),_zanToptips2=_interopRequireDefault(_zanToptips),_zanLoadmore=require("./../../components/zan-loadmore.js"),_zanLoadmore2=_interopRequireDefault(_zanLoadmore),WorkTypes=constant.WorkTypes,deviceTypes=["托盘","箱子"],urls={20:"./instorage/chooseC",21:"./putaway/index",22:"./ex/scanBox",23:"./picking/chooseA",25:"./check/sureNum",26:"./binning/scan"},startUrls={20:"./instorage/scanSn",21:"./putaway/index",22:"./ex/scanId",23:"./picking/chooseA",25:"./check/sureNum",26:"./binning/scan",27:"./devanning/scan"},Index=function(e){function t(){var e,s,a,r;_classCallCheck(this,t);for(var n=arguments.length,o=Array(n),i=0;i<n;i++)o[i]=arguments[i];return s=a=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(o))),a.config={navigationBarTitleText:"待办工作"},a.mixins=[_wxex2.default],a.$repeat={},a.$props={zanTab:{"xmlns:v-bind":"","v-bind:tab.sync":"tab",componentId:"tab"},zanLoadmore:{"v-bind:nodata.once":"isEmpty",nodata_str:"做事太有效率了，事情都做完啦"}},a.$events={},a.components={zanTab:_zanTab2.default,zanToptips:_zanToptips2.default,zanLoadmore:_zanLoadmore2.default},a.data={reload:!1,busyKey:"",busyType:"",isLock:!1,startWithArea:[20,21,22,23,26,27],showStartWithArea:!1,id:0,dataList:[],list:[],pageNum:1,loadList:!0,scrollTop:0,showType:1,tab:{list:[],selectedId:"",scroll:!0,height:45},pickAddress:[],userInfo:{nickName:"加载中..."}},a.events={zanTabChange:function(e,t){var s=e.componentId,a=e.selectedId;this[s].selectedId=a,this.pageNum=1,this.loadList=!0,this.dataList=[],this.scrollTop=0,this.showStartWithArea=this.startWithArea.includes(a),this.showStartWithArea&&this.getAddresses(),this.getUserWorkStatis(a),this.goTop(),this.$apply()}},a.methods={lower:function(){a.loadList&&(a.pageNum+=1,a.getTodoWorks())},handleStartWork:function(e){var t=a.tab.selectedId;switch(t){case 20:case 22:case 25:a.$navigate(startUrls[t])}},bindPickAreaChange:function(e){var t=a.tab.selectedId,s=e.detail.value,r=a.pickAddress[s].addressId;switch(a.$preload("addressId",r),a.$preload("from",1),t){case 20:a.$navigate("./instorage/scanSn");break;case 21:a.$navigate("./putaway/storehouse-list");break;case 22:a.$navigate("./ex/scanId");break;case 23:var n={addressId:a.pickAddress[s].addressId,busyType:23,busyKey:""};a.checkTask(n);break;case 26:case 27:a.$navigate(startUrls[t])}},showDetail:function(e){a.$preload("workinfo",e),a.$navigate("work/info")},chooseContainer:function(e){console.log(e),a.$preload("from",2),23==e.busyType?a.checkTask(e):27==e.busyType?a.getUnboxArea(e):26==e.busyType?(console.log("26===>"),console.log(e),e.workMap.goodNo?(a.$preload("work",e),a.$navigate("./binning/print")):(a.$preload("work",e),a.$preload("flag",1),a.$navigate(urls[e.busyType]))):(a.$preload("work",e),a.$preload("flag",1),a.$navigate(urls[e.busyType]))},handleEntrust:function(e){console.log(e);var t=Object.assign({},e);if(console.log(t.isHavePerm,t.entrustId,t.entrustStatus),2==t.isHavePerm)t.entrustType=1,a.gotoMate(t);else{var s="您已获得授权，除了委托当前事务，还可以委托更长时间的“"+t.busyTypeText+"”工作至："+(t.expireTime||"forerver");wx.showModal({content:s,showCancel:!1,success:function(e){e.confirm&&wx.showActionSheet({itemList:["仅委托当前事务","委托更长时间"],success:function(e){t.entrustType=e.tapIndex+1,a.gotoMate(t)},fail:function(e){console.log(e.errMsg)}})}})}}},r=s,_possibleConstructorReturn(a,r)}return _inherits(t,e),_createClass(t,[{key:"onShow",value:function(){console.log("show:"+this.reload),this.reload&&(console.log("reload= datalist==>"),this.pageNum=1,this.loadList=!0,this.tab.selectedId?this.getUserWorkStatis(this.tab.selectedId):this.getUserWorkStatis(),this.reload=!1,this.$apply())}},{key:"onLoad",value:function(){this.pageNum=1,this.loadList=!0,this.tab.selectedId?this.getUserWorkStatis(this.tab.selectedId):this.getUserWorkStatis(),this.$apply()}},{key:"onHide",value:function(){this.pageNum=1,this.loadList=!0,this.reload=!0,console.log("onHide:"+this.reload),this.$apply()}},{key:"onPageScroll",value:function(e){console.log(e)}},{key:"goTop",value:function(){console.log(wx.pageScrollTo),wx.pageScrollTo?wx.pageScrollTo({scrollTop:10}):wx.showModal({title:"提示",content:"当前微信版本过低，无法使用该功能，请升级到最新微信版本后重试。"})}},{key:"gotoMate",value:function(e){this.$preload("entrustInfo",e),this.$navigate("./torobs/card-workmate")}},{key:"back",value:function(){var e=this.backUrl("todo",!0),t=e.delta;e.targetPage.setParams({reload:!0}),wx.navigateBack({delta:t})}},{key:"getUserWorkStatis",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var s,a,r,n=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_service2.default.Aget("work/getUserWorkStatis",{});case 2:s=e.sent,a=s.res,r=s.state,r?(this.tab.list=[{id:"",title:"全部",num:!1}],a=a.map(function(e){return{id:e.busytype,title:e.permname,num:e.num}}),this.tab.list=this.tab.list.concat(a),this.tab.selectedId="",Object.keys(this.tab.list).forEach(function(e){n.tab.list[e].id===t&&(n.tab.selectedId=t)})):(""!=this.tab.selectedId&&this.showTips(a),this.showType=2),""==this.tab.selectedId?this.getTodoWorks():this.getTodoWorks(t),this.$apply();case 8:case"end":return e.stop()}},e,this)}));return e}()},{key:"getTodoWorks",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var s,a,r,n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return wx.showLoading({title:"加载中",mask:!0}),s={ucId:this.userInfo.ucId,tk:this.userInfo.token,busyType:this.tab.selectedId||"",pageNum:this.pageNum,pageSize:20},e.next=4,_service2.default.Aget("work/getTodoWorks",s);case 4:a=e.sent,r=a.res,n=a.msg,o=a.state,wx.hideLoading(),1==this.pageNum&&(this.dataList=[]),this.loadList=o,o?(this.dataList=this.dataList.concat(r),this.formatList(this.dataList),this.loadList=!0):(1==this.pageNum&&(this.list=[],wx.showToast({title:"暂无数据",icon:"success",duration:1e3,success:function(){}})),t&&""!=t&&(this.tab.selectedId="",this.getUserWorkStatis(this.tab.selectedId))),this.reload=!1,this.busyKey="",this.busyType="",this.$apply();case 16:case"end":return e.stop()}},e,this)}));return e}()},{key:"formatList",value:function(e){var t=this;this.list=e.map(function(e){if(21==e.busyType){var s=e.workMap,a=s.deviceType,r=s.deviceSn,n=s.areaName;e.showText=deviceTypes[a-1]+"："+r+"，"+n}else 20==e.busyType?e.workMap?e.showText="单号："+e.workMap.cgOrder:e.showText="单号："+e.busySn:22==e.busyType?e.workMap?e.showText="单号："+e.workMap.cgOrder:e.showText="单号："+e.busySn:23==e.busyType?e.workMap?e.showText="单号："+e.workMap.cgOrder:e.showText="单号："+e.busySn:25==e.busyType?(e.showText="货品："+e.workMap.GoodNo,e.showText1="位置："+e.workMap.PositionSn):26==e.busyType?1===e.workMap.status?e.showText="拣货箱："+e.workMap.deviceSn:e.showText="货号："+e.workMap.goodNo+"，"+e.workMap.addressName+"，"+e.workMap.packageNum+"号箱":27==e.busyType&&(e.showText="货品："+e.workMap.GoodNo);var o=Number.parseInt(new Date-new Date(e.createTime))/1e3/60;e.beforeTime=o<1?"刚刚":o<60?Number.parseInt(o)+"分钟前":o<1440?Number.parseInt(o/60)+"小时前":Number.parseInt(o/60/24)+"天前";var i=t.tab.list.filter(function(t){return t.id==e.busyType});return e.busyTypeText=i.length>0?i[0].title:"",e}),this.$apply()}},{key:"getUnboxArea",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var s,a,r,n,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s={ucId:this.userInfo.ucId,tk:this.userInfo.token,taskId:t.busyKey,addressId:t.addressId},e.next=3,_service2.default.Aget("unbox/getUnboxArea",s);case 3:a=e.sent,r=a.res,n=a.state,o=a.msg,i=a.code,200==i?(this.$preload("info",{work:t,areaList:r}),this.$navigate("./devanning/scan")):(this.unboxArea=[],this.showTips(o)),this.$apply();case 10:case"end":return e.stop()}},e,this)}));return e}()},{key:"getAddresses",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,s,a,r,n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t={ucId:this.userInfo.ucId,tk:this.userInfo.token},e.next=3,_service2.default.Aget("pick/getAddresses",t);case 3:s=e.sent,a=s.res,r=s.state,n=s.msg,o=s.code,200==o?this.pickAddress=a:(this.pickAddress=[],this.showTips(n)),this.$apply();case 10:case"end":return e.stop()}},e,this)}));return e}()},{key:"checkTask",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var s,a,r,n,o,i,c,u=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s={ucId:this.userInfo.ucId,tk:this.userInfo.token,pickOrderId:t.busyKey,addressId:t.addressId},a=this,e.next=4,_service2.default.Aget("pick/checkTask",s);case 4:r=e.sent,n=r.res,o=r.msg,i=r.state,c=r.code,2004==c?wx.showModal({content:"您尚有未结束的分拣作业！",confirmText:"退出",cancelText:"继续",success:function(e){e.confirm?u.finishTask(n.taskId):(n.addressId=t.addressId,u.$preload("taskInfo",n),2==n.packageType&&0==n.deviceNum?(u.$navigate("./picking/scanBox"),console.log("scan")):(u.$navigate("./picking/sureNum"),console.log("sure")))}}):200==c?(this.$preload("info",{work:t,areaList:n}),this.$navigate(urls[t.busyType])):this.showTips(o);case 10:case"end":return e.stop()}},e,this)}));return e}()},{key:"finishTask",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var s,a,r,n,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s={ucId:this.userInfo.ucId,tk:this.userInfo.token,taskId:t},e.next=3,_service2.default.Apost("pick/finishTask",s);case 3:a=e.sent,r=a.res,n=a.state,o=a.msg,i=a.code,200==i?this.showTips(o,"success"):this.showTips(o);case 9:case"end":return e.stop()}},e,this)}));return e}()},{key:"setParams",value:function(e){this.params=e,e.reload&&(this.reload=e.reload,this.isLock=!1),e.busyKey&&(this.busyKey=e.busyKey,this.busyType=e.busyType),this.$apply()}}]),t}(_wepy2.default.page);Page(require("./../../npm/wepy/lib/wepy.js").default.$createPage(Index,"pages/workbench/todo"));