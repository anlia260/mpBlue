"use strict";function GETData(){return BLData}function getPT(){wx.getSystemInfo({success:function(e){pingtai=e.platform,console.log("getpt:",pingtai)}})}function OpenP(){getPT(),BLSB=new Array,wx.openBluetoothAdapter({success:function(e){console.log(e.errMsg),"openBluetoothAdapter:ok"==e.errMsg?(BLData.openOK=!0,BLData.TS="蓝牙模块初始化成功!",GetBLZT()):BLData.TS="请先打开蓝牙开关!"},fail:function(e){BLData.TS="请先打开蓝牙开关!"}})}function GetBLZT(){wx.getBluetoothAdapterState({success:function(e){e.available&&(BLData.BLZT=!0,BLData.TS="蓝牙适配器状态可用",SOBL())}}),wx.onBluetoothAdapterStateChange(function(e){e.available?(BLData.BLZT=!0,BLData.TS="蓝牙适配器状态可用",SOBL()):(BLData.BLZT=!1,BLData.TS="蓝牙适配器当前不可用")})}function SOBL(){BLData.TS="开始搜索蓝牙设备",wx.startBluetoothDevicesDiscovery({success:function(e){"startBluetoothDevicesDiscovery:ok"==e.errMsg&&(BLData.BLZT=!0,BLData.TS="开始搜索蓝牙设备",newSB())}})}function newSB(){wx.onBluetoothDeviceFound(function(e){var i={name:"",id:"",tp:"",dis:!1,LJ:"1",LJOK:"0"};if(BLData.TS="搜索到蓝牙设备",console.log("localName:",e.devices[0].localName),""!=e.devices[0].localName&&e.devices[0].localName&&!chongfu(e.devices[0].deviceId)){i.name=e.devices[0].localName,i.id=e.devices[0].deviceId;var n=e.devices[0].RSSI;i.tp=n>-70?"xinhao5":n>-85?"xinhao4":n>-90?"xinhao3":n>-100?"xinhao2":"xinhao1",i.dis=!1,i.LJ="0",BLSB.push(i)}})}function chongfu(e){var i=!1;for(var n in BLSB)BLSB[n].id==e&&(i=!0);return i}function GETSB(){return BLSB}function stopSO(){console.log("停止搜索:"),wx.stopBluetoothDevicesDiscovery({success:function(e){console.log("停止搜索成功:",e),wx.onBluetoothAdapterStateChange(function(e){console.log("adapterState changed, now is",e)})},fail:function(e){console.log("停止搜索失败:",e)}})}function stopBL(){wx.stopBluetoothDevicesDiscovery({success:function(e){wx.closeBluetoothAdapter({success:function(e){console.log(e)}})}})}function lianjie(e){""!=dayinji.uuid&&dayinji.uuid!=e&&duankai(dayinji.uuid),lcs=0,cgcs=0,lianjiego(e),hidesb(e,"1")}function hidesb(e,i){for(var n in BLSB)BLSB[n].id==e&&(BLSB[n].LJ=i)}function lianjiego(e){lcs+=1,console.log("第"+lcs+"次尝试连接"),wx.createBLEConnection({deviceId:e,success:function(i){stopSO(),cgcs+=1,console.log("连接成功.第"+lcs+"次:",i),1==cgcs&&jtlj(),jianting=!1,hidesb(e,"2"),getFW(e)},fail:function(i){console.log("连接失败:",i),lcs>5?hidesb(e,"3"):lianjiego(e)}})}function duankai(e){hidesb(e,"0"),jianting=!0,wx.closeBLEConnection({deviceId:e,success:function(e){console.log("断开成功:",e)}})}function jtlj(){wx.onBLEConnectionStateChange(function(e){0==e.connected&&0==jianting&&(console.log("监测到断开,自动重连"),hidesb(e.deviceId,"1"),lianjiego(e.deviceId),jianting=!0)})}function getFW(e){wx.getBLEDeviceServices({deviceId:e,success:function(i){console.log("所有服务:",i);for(var n in i.services)getTZ(e,i.services[n].uuid,n)}})}function getTZ(e,i,n){wx.getBLEDeviceCharacteristics({deviceId:e,serviceId:i,success:function(o){console.log("----------第"+n+"服务值------------");for(var t in o.characteristics){var c=o.characteristics[t].properties;dayinji.uuid=e,dayinji.suuid=i,c.write&&4==n&&(console.log("入参："+e,i),console.log("所有特征值:",o),dayinji.nuuid=o.characteristics[t].uuid,console.log("蓝牙值：",dayinji,"第"+(parseInt(t)+1)+"组特征")),wx.setStorage({key:"dayinji",data:dayinji}),c.notify&&4==n&&wx.notifyBLECharacteristicValueChange({state:!0,deviceId:e,serviceId:i,characteristicId:o.characteristics[t].uuid,complete:function(e){console.log(e),wx.onBLECharacteristicValueChange(function(e){console.log(e)})},fail:function(e){}})}}})}function zdlianjie(){try{var e=wx.getStorageSync("dayinji");e&&wx.openBluetoothAdapter({success:function(i){lianjie(e.uuid)},fail:function(e){BLData.TS="请先打开蓝牙开关!"}})}catch(e){console.log("读取缓存数据错误:",e)}}var BLData={openOK:!1,BLZT:!1,BLSO:!1,TS:"开始初始化蓝牙模块..."},dayinji={uuid:"",suuid:"",nuuid:""},pingtai,BLSB=new Array;module.exports={dayinji:dayinji,OpenPrint:OpenP,GETData:GETData,GETSB:GETSB,stopBL:stopBL,lianjie:lianjie,duankai:duankai,pingtai:pingtai,getPT:getPT,zdlj:zdlianjie};var lcs=0,cgcs=0,jianting=!1;